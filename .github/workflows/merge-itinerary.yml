name: è‡ªå‹•åˆä½µè¡Œç¨‹æª”æ¡ˆ

on:
  push:
    paths:
      - '**/D*.md'
      - '**/todo.md'
      - '**/è¡Œç¨‹ç¸½è¦½.md'
      - '**/*è¡Œç¨‹ç¸½è¦½*.md'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.detect.outputs.projects }}
    steps:
    - name: Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: åµæ¸¬è®Šæ›´çš„å°ˆæ¡ˆ
      id: detect
      run: |
        # å–å¾—è®Šæ›´çš„æª”æ¡ˆåˆ—è¡¨
        CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
        echo "Changed files: $CHANGED_FILES"
        
        # åµæ¸¬å“ªäº›å°ˆæ¡ˆç›®éŒ„æœ‰è®Šæ›´
        PROJECTS=()
        
        for file in $CHANGED_FILES; do
          echo "Checking file: $file"
          # æª¢æŸ¥æ˜¯å¦ç‚ºè¡Œç¨‹ç›¸é—œæª”æ¡ˆ (æ”¾å¯¬æ¢ä»¶)
          if [[ $file =~ D[0-9]+\.md$ ]] || [[ $file =~ todo\.md$ ]] || [[ $file =~ è¡Œç¨‹ç¸½è¦½.*\.md$ ]]; then
            # æå–å°ˆæ¡ˆè·¯å¾‘ (ä¾‹å¦‚: 2025/tokyo)
            PROJECT_DIR=$(dirname "$file")
            echo "Found itinerary file in: $PROJECT_DIR"
            
            # æª¢æŸ¥å°ˆæ¡ˆç›®éŒ„æ˜¯å¦å­˜åœ¨ä¸»è¡Œç¨‹æª”æ¡ˆ
            if ls "$PROJECT_DIR"/*è¡Œç¨‹ç¸½è¦½*.md 1> /dev/null 2>&1; then
              echo "Found main itinerary file in $PROJECT_DIR"
              # é¿å…é‡è¤‡æ·»åŠ 
              if [[ ! " ${PROJECTS[@]} " =~ " ${PROJECT_DIR} " ]]; then
                PROJECTS+=("$PROJECT_DIR")
                echo "Added project: $PROJECT_DIR"
              fi
            else
              echo "No main itinerary file found in $PROJECT_DIR"
            fi
          fi
        done
        
        # ç°¡å–®çš„ JSON é™£åˆ—å»ºæ§‹ (é¿å…ä¾è³´ jq)
        if [ ${#PROJECTS[@]} -eq 0 ]; then
          PROJECTS_JSON="[]"
          echo "No projects detected"
        else
          PROJECTS_JSON="["
          for i in "${!PROJECTS[@]}"; do
            if [ $i -gt 0 ]; then
              PROJECTS_JSON+=","
            fi
            PROJECTS_JSON+="\"${PROJECTS[i]}\""
          done
          PROJECTS_JSON+="]"
          echo "Projects detected: ${#PROJECTS[@]}"
        fi
        
        # ç¢ºä¿ç¸½æ˜¯è¼¸å‡ºæœ‰æ•ˆçš„ JSON
        if [ -z "$PROJECTS_JSON" ]; then
          PROJECTS_JSON="[]"
        fi
        
        echo "projects=$PROJECTS_JSON" >> $GITHUB_OUTPUT
        echo "Final output: $PROJECTS_JSON"

  merge-files:
    needs: detect-changes
    if: needs.detect-changes.outputs.projects != '[]' && needs.detect-changes.outputs.projects != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: ${{ fromJson(needs.detect-changes.outputs.projects || '[]') }}
    
    steps:
    - name: Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: åˆä½µ ${{ matrix.project }} è¡Œç¨‹æª”æ¡ˆ
      run: |
        cd "${{ matrix.project }}"
        
        # å°‹æ‰¾ä¸»è¡Œç¨‹æª”æ¡ˆ
        MAIN_FILE=$(ls *è¡Œç¨‹ç¸½è¦½*.md | head -n1)
        echo "Main file: $MAIN_FILE"
        
        # å‚™ä»½åŸå§‹æª”æ¡ˆ
        cp "$MAIN_FILE" "${MAIN_FILE}.backup"
        
        # è®€å–åŸæª”æ¡ˆçš„æ¨™é¡Œå’Œç›®éŒ„éƒ¨åˆ†
        TITLE=$(head -n1 "$MAIN_FILE")
        
        # å»ºç«‹æ–°çš„åˆä½µæª”æ¡ˆé–‹é ­
        echo "$TITLE" > temp_merged.md
        echo "" >> temp_merged.md

        echo "## æœ€å¾Œæ›´æ–°æ™‚é–“:" >> temp_merged.md
        echo "" >> temp_merged.md
        echo "$(date '+%Y-%m-%d %H:%M:%S UTC')" >> temp_merged.md
        echo "" >> temp_merged.md
        
        # æå–ä¸¦ä¿ç•™ç›®éŒ„éƒ¨åˆ†ï¼ˆåˆ°ç¬¬ä¸€å€‹ --- ç‚ºæ­¢ï¼‰
        sed -n '2,/^---$/p' "$MAIN_FILE" >> temp_merged.md
        
        # æ·»åŠ è‡ªå‹•ç”Ÿæˆè¨»é‡‹
        echo "<!-- ä»¥ä¸‹ç‚ºå®Œæ•´è¡Œç¨‹å…§å®¹ï¼Œç”± GitHub Actions è‡ªå‹•åˆä½µç”Ÿæˆ -->" >> temp_merged.md
        echo "" >> temp_merged.md
        
        # åˆä½µæ‰€æœ‰ D*.md æª”æ¡ˆ
        for day_file in D*.md; do
          if [ -f "$day_file" ]; then
            echo "" >> temp_merged.md
            cat "$day_file" >> temp_merged.md
            echo "" >> temp_merged.md
          fi
        done
        
        # æ·»åŠ  TODO æ¸…å–®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "todo.md" ]; then
          echo "" >> temp_merged.md
          echo "---" >> temp_merged.md
          echo "" >> temp_merged.md
          cat todo.md >> temp_merged.md
        fi
        
        # æ›¿æ›åŸæª”æ¡ˆ
        mv temp_merged.md "$MAIN_FILE"
        
        # æ¸…ç†å‚™ä»½æª”æ¡ˆ
        rm "${MAIN_FILE}.backup"

    - name: æäº¤è®Šæ›´
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add "${{ matrix.project }}"/*è¡Œç¨‹ç¸½è¦½*.md
        git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªå‹•åˆä½µ ${{ matrix.project }} è¡Œç¨‹æª”æ¡ˆ

        ğŸ”„ Generated with [Claude Code](https://claude.ai/code)

        Co-Authored-By: Claude <noreply@anthropic.com>"
        git push
