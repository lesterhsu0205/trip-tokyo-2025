name: è‡ªå‹•åˆä½µè¡Œç¨‹æª”æ¡ˆ

on:
  push:
    paths:
      - '**/D*.md'
      - '**/todo.md'
      - '**/README.md'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.detect.outputs.projects }}
    steps:
    - name: Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: åµæ¸¬è®Šæ›´çš„å°ˆæ¡ˆ
      id: detect
      run: |
        # å–å¾—è®Šæ›´çš„æª”æ¡ˆåˆ—è¡¨
        CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
        echo "Changed files: $CHANGED_FILES"
        
        # åµæ¸¬å“ªäº›å°ˆæ¡ˆç›®éŒ„æœ‰è®Šæ›´
        PROJECTS=()
        
        for file in $CHANGED_FILES; do
          echo "Checking file: $file"
          # æª¢æŸ¥æ˜¯å¦ç‚ºè¡Œç¨‹ç›¸é—œæª”æ¡ˆ (æ”¾å¯¬æ¢ä»¶)
          if [[ $file =~ D[0-9]+\.md$ ]] || [[ $file =~ todo\.md$ ]] || [[ $file =~ README.*\.md$ ]]; then
            # æå–å°ˆæ¡ˆè·¯å¾‘ (ä¾‹å¦‚: 2025/tokyo)
            PROJECT_DIR=$(dirname "$file")
            echo "Found itinerary file in: $PROJECT_DIR"
            
            # æª¢æŸ¥å°ˆæ¡ˆç›®éŒ„æ˜¯å¦å­˜åœ¨ä¸»è¡Œç¨‹æª”æ¡ˆ
            if ls "$PROJECT_DIR"/README.md 1> /dev/null 2>&1; then
              echo "Found main itinerary file in $PROJECT_DIR"
              # é¿å…é‡è¤‡æ·»åŠ 
              if [[ ! " ${PROJECTS[@]} " =~ " ${PROJECT_DIR} " ]]; then
                PROJECTS+=("$PROJECT_DIR")
                echo "Added project: $PROJECT_DIR"
              fi
            else
              echo "No main itinerary file found in $PROJECT_DIR"
            fi
          fi
        done
        
        # ç°¡å–®çš„ JSON é™£åˆ—å»ºæ§‹ (é¿å…ä¾è³´ jq)
        if [ ${#PROJECTS[@]} -eq 0 ]; then
          PROJECTS_JSON="[]"
          echo "No projects detected"
        else
          PROJECTS_JSON="["
          for i in "${!PROJECTS[@]}"; do
            if [ $i -gt 0 ]; then
              PROJECTS_JSON+=","
            fi
            PROJECTS_JSON+="\"${PROJECTS[i]}\""
          done
          PROJECTS_JSON+="]"
          echo "Projects detected: ${#PROJECTS[@]}"
        fi
        
        # ç¢ºä¿ç¸½æ˜¯è¼¸å‡ºæœ‰æ•ˆçš„ JSON
        if [ -z "$PROJECTS_JSON" ]; then
          PROJECTS_JSON="[]"
        fi
        
        echo "projects=$PROJECTS_JSON" >> $GITHUB_OUTPUT
        echo "Final output: $PROJECTS_JSON"

  set-updating-status:
    needs: detect-changes
    if: needs.detect-changes.outputs.projects != '[]' && needs.detect-changes.outputs.projects != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: ${{ fromJson(needs.detect-changes.outputs.projects || '[]') }}
    
    steps:
    - name: Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è¨­ç½® ${{ matrix.project }} æ›´æ–°ä¸­ç‹€æ…‹
      run: |
        cd "${{ matrix.project }}"
        
        # å°‹æ‰¾ä¸»è¡Œç¨‹æª”æ¡ˆ
        MAIN_FILE="README.md"
        echo "Main file: $MAIN_FILE"
        
        # å‰µå»ºåŸå§‹æª”æ¡ˆå‚™ä»½ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡æ™‚ï¼‰
        if [ ! -f "${MAIN_FILE}.original" ]; then
          # æå–ç›®éŒ„éƒ¨åˆ†ï¼ˆåˆ°ç¬¬ä¸€å€‹å«æœ‰è¡Œç¨‹å…§å®¹çš„ --- ç‚ºæ­¢ï¼‰
          awk '
            BEGIN { in_toc = 1; found_divider = 0 }
            /^---$/ && in_toc { 
              found_divider++; 
              if(found_divider >= 2) in_toc = 0; 
              next 
            }
            in_toc && !/^## ğŸ”„ æœ€å¾Œæ›´æ–°æ™‚é–“$/ && !/^ğŸ”„ \*\*æ›´æ–°ä¸­/ && !/^âœ… \*\*[0-9]/ { print }
          ' "$MAIN_FILE" > "${MAIN_FILE}.original"
        fi
        
        # è®€å–æ¨™é¡Œå’Œç›®éŒ„éƒ¨åˆ†
        TITLE=$(head -n1 "${MAIN_FILE}.original")
        
        # å»ºç«‹æ–°çš„åˆä½µæª”æ¡ˆ
        echo "$TITLE" > temp_merged.md
        echo "" >> temp_merged.md
        
        # æ·»åŠ ç›®éŒ„éƒ¨åˆ†ï¼ˆè·³éç¬¬ä¸€è¡Œæ¨™é¡Œï¼‰
        tail -n +2 "${MAIN_FILE}.original" >> temp_merged.md
        
        # æ·»åŠ æ›´æ–°ä¸­ç‹€æ…‹å€å¡Š
        echo "## ğŸ”„ æœ€å¾Œæ›´æ–°æ™‚é–“" >> temp_merged.md
        echo "" >> temp_merged.md
        echo "ğŸ”„ **æ›´æ–°ä¸­ï¼Œè«‹æŒçºŒé‡æ–°æ•´ç†**" >> temp_merged.md
        echo "" >> temp_merged.md
        echo "---" >> temp_merged.md
        
        # æ·»åŠ è‡ªå‹•ç”Ÿæˆè¨»é‡‹
        echo "<!-- ä»¥ä¸‹ç‚ºå®Œæ•´è¡Œç¨‹å…§å®¹ï¼Œç”± GitHub Actions è‡ªå‹•åˆä½µç”Ÿæˆ -->" >> temp_merged.md
        echo "<!-- åˆä½µé–‹å§‹æ™‚é–“: $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S (UTC+8)') -->" >> temp_merged.md
        echo "" >> temp_merged.md
        
        # åˆä½µæ‰€æœ‰ D*.md æª”æ¡ˆ
        for day_file in D*.md; do
          if [ -f "$day_file" ]; then
            echo "" >> temp_merged.md
            cat "$day_file" >> temp_merged.md
            echo "" >> temp_merged.md
          fi
        done
        
        # æ·»åŠ  TODO æ¸…å–®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "todo.md" ]; then
          echo "" >> temp_merged.md
          echo "---" >> temp_merged.md
          echo "" >> temp_merged.md
          cat todo.md >> temp_merged.md
        fi
        
        # æ›¿æ›åŸæª”æ¡ˆ
        mv temp_merged.md "$MAIN_FILE"

    - name: æäº¤æ›´æ–°ä¸­ç‹€æ…‹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add "${{ matrix.project }}"/README.md "${{ matrix.project }}"/README.md.original
        git diff --staged --quiet || git commit -m "ğŸ”„ é–‹å§‹æ›´æ–° ${{ matrix.project }} è¡Œç¨‹æª”æ¡ˆ

        ğŸ”„ Generated with [Claude Code](https://claude.ai/code)

        Co-Authored-By: Claude <noreply@anthropic.com>"
        git push

  merge-files:
    needs: [detect-changes, set-updating-status]
    if: needs.detect-changes.outputs.projects != '[]' && needs.detect-changes.outputs.projects != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: ${{ fromJson(needs.detect-changes.outputs.projects || '[]') }}
    
    steps:
    - name: Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main

    - name: åˆä½µ ${{ matrix.project }} è¡Œç¨‹æª”æ¡ˆ
      run: |
        cd "${{ matrix.project }}"
        
        # å°‹æ‰¾ä¸»è¡Œç¨‹æª”æ¡ˆ
        MAIN_FILE="README.md"
        echo "Main file: $MAIN_FILE"
        
        # æª¢æŸ¥æ˜¯å¦å­˜åœ¨åŸå§‹çš„ README.md.original å‚™ä»½æª”æ¡ˆ
        if [ ! -f "${MAIN_FILE}.original" ]; then
          # å¦‚æœä¸å­˜åœ¨ï¼Œèªªæ˜é€™æ˜¯ç¬¬ä¸€æ¬¡é‹è¡Œï¼Œå¾ç•¶å‰æª”æ¡ˆä¸­æå–åŸå§‹å…§å®¹
          # æå–ç›®éŒ„éƒ¨åˆ†ï¼ˆåˆ°ç¬¬ä¸€å€‹å«æœ‰è¡Œç¨‹å…§å®¹çš„ --- ç‚ºæ­¢ï¼‰
          awk '
            BEGIN { in_toc = 1; found_divider = 0 }
            /^---$/ && in_toc { 
              found_divider++; 
              if(found_divider >= 2) in_toc = 0; 
              next 
            }
            in_toc && !/^## ğŸ”„ æœ€å¾Œæ›´æ–°æ™‚é–“$/ && !/^ğŸ”„ \*\*æ›´æ–°ä¸­/ && !/^âœ… \*\*[0-9]/ { print }
          ' "$MAIN_FILE" > "${MAIN_FILE}.original"
        fi
        
        # è®€å–æ¨™é¡Œå’Œç›®éŒ„éƒ¨åˆ†
        TITLE=$(head -n1 "${MAIN_FILE}.original")
        
        # å»ºç«‹æ–°çš„åˆä½µæª”æ¡ˆ
        echo "$TITLE" > temp_merged.md
        echo "" >> temp_merged.md
        
        # æ·»åŠ ç›®éŒ„éƒ¨åˆ†ï¼ˆè·³éç¬¬ä¸€è¡Œæ¨™é¡Œï¼‰
        tail -n +2 "${MAIN_FILE}.original" >> temp_merged.md
        
        # æ·»åŠ æœ€å¾Œæ›´æ–°æ™‚é–“å€å¡Šï¼ˆå®Œæˆç‹€æ…‹ï¼‰
        echo "## ğŸ”„ æœ€å¾Œæ›´æ–°æ™‚é–“" >> temp_merged.md
        echo "" >> temp_merged.md
        echo "âœ… **$(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S (UTC+8)')** - æ›´æ–°å®Œæˆ" >> temp_merged.md
        echo "" >> temp_merged.md
        echo "---" >> temp_merged.md
        
        # æ·»åŠ è‡ªå‹•ç”Ÿæˆè¨»é‡‹
        echo "<!-- ä»¥ä¸‹ç‚ºå®Œæ•´è¡Œç¨‹å…§å®¹ï¼Œç”± GitHub Actions è‡ªå‹•åˆä½µç”Ÿæˆ -->" >> temp_merged.md
        echo "<!-- åˆä½µå®Œæˆæ™‚é–“: $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S (UTC+8)') -->" >> temp_merged.md
        echo "" >> temp_merged.md
        
        # åˆä½µæ‰€æœ‰ D*.md æª”æ¡ˆ
        for day_file in D*.md; do
          if [ -f "$day_file" ]; then
            echo "" >> temp_merged.md
            cat "$day_file" >> temp_merged.md
            echo "" >> temp_merged.md
          fi
        done
        
        # æ·»åŠ  TODO æ¸…å–®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "todo.md" ]; then
          echo "" >> temp_merged.md
          echo "---" >> temp_merged.md
          echo "" >> temp_merged.md
          cat todo.md >> temp_merged.md
        fi
        
        # æ›¿æ›åŸæª”æ¡ˆ
        mv temp_merged.md "$MAIN_FILE"

    - name: æäº¤è®Šæ›´
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add "${{ matrix.project }}"/README.md
        git diff --staged --quiet || git commit -m "âœ… å®Œæˆæ›´æ–° ${{ matrix.project }} è¡Œç¨‹æª”æ¡ˆ

        ğŸ”„ Generated with [Claude Code](https://claude.ai/code)

        Co-Authored-By: Claude <noreply@anthropic.com>"
        git push
